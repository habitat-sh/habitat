FROM {{base_image}}
ENV PATH {{path}}

{{~ #if multi_layer }}
{{~ #each packages as |pkg|}}
COPY {{../rootfs}}/hab/pkgs/{{pkg}} /hab/pkgs/{{pkg}}
{{ /each }}

# NOTE: The rest of these commands are duplicating things that are just
# copied over directly from the rootfs in the non-multi-layer
# scenario.

# Contains all our busybox userspace links, hab binary link, and any user
# package binary links
COPY {{rootfs}}/bin /bin

RUN \
    # Remember, in order to be able to run a Supervisor as non-root,
    # we must at least have write access to the /hab directory. If you
    # further wish to run an *updating* Supervisor (or one that
    # updates its services), you will (generically) require write
    # access to everything under `/hab/pkgs` as well.
    #
    # (One final note: we run this `find` command *after* we set up /bin
    # to avoid having to call our busybox binary directly.)
    find /hab -type d -exec chmod g=u {} \; && \
    # Create the minimum amount of directories for things to work.
    #
    # /tmp is particularly required for the Supervisor / Launcher
    # communication pipe.
    mkdir /root && chmod 750 root && \
    mkdir /tmp && chmod 1777 /tmp && \
    mkdir -p /var/tmp && chmod 1777 /var/tmp

# Ensure our custom /etc content (notably `passwd` and `group` files,
# but also our linked cacerts in /etc/ssl) are present.
COPY {{rootfs}}/etc /etc
COPY {{rootfs}}/init.sh /init.sh

{{~ else }}
ADD {{rootfs}} /
{{~ /if }}

# Remember, in order to be able to run a Supervisor as non-root,
# we must at least have write access to the /hab directory. If you
# further wish to run an *updating* Supervisor (or one that
# updates its services), you will (generically) require write
# access to everything under `/hab/pkgs` as well.
RUN find /hab -type d -exec chmod g=u {} \;

EXPOSE 9631 {{exposes}}
RUN HAB_FEAT_OFFLINE_INSTALL=ON \
    {{~ #if environment}}
    {{~ #each environment}}
        {{@key}}={{{this}}} \
    {{~ /each}}
    {{~ /if}}
    {{hab_path}} pkg install {{installed_primary_svc_ident}}
ENTRYPOINT ["/init.sh"]
CMD ["run", "{{primary_svc_ident}}"]
