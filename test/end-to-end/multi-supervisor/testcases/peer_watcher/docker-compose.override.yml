version: '3.8'
services:

  alpha:
    # Overriding to add `--peer-watch-file` option
    command:
      - run
      - --listen-ctl=0.0.0.0:9632
      - --peer-watch-file=/hab/PEERS
    volumes:
      - ./testcases/peer_watcher/PEERS:/hab/PEERS

  beta:
    # Overriding to add `--peer-watch-file` option
    command:
      - run
      - --listen-ctl=0.0.0.0:9632
      - --peer-watch-file=/hab/PEERS

  tester:
    image: ${TESTCASE}_image
    domainname: habitat.dev
    environment:
      HAB_LICENSE: accept-no-persist
      HAB_NONINTERACTIVE: '1'
      TESTCASE: ${TESTCASE}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
      HAB_AUTH_TOKEN: ${HAB_AUTH_TOKEN}
    volumes:
      - source: ./testcases/peer_watcher/PEERS:/hab/PEERS
        target: /hab/PEERS
        type: bind
      - source: ./CTL_SECRET
        target: /hab/sup/default/CTL_SECRET
        type: bind
      - source: /var/run/docker.sock
        target: /var/run/docker.sock
        type: bind
      - source: ../../../.expeditor/scripts
        target: /scripts
        type: bind
    build:
      context: ${TESTCASE_DIR}
    depends_on:
      - bastion
      - alpha
      - beta
