version: '3.8'
services:

  # The repetition of the additional volume mounts as well as the
  # extra --org option pains my soul, but it doesn't appear that the
  # docker-compose `extends` feature allows you to reach back to
  # previous "layers" to modify them and let those changes naturally
  # bubble up.

  # Even though we'll be loading the files to the bastion, it doesn't
  # actually need to be running with the same `org` as the others. It
  # also doesn't need access to the keys, because it doesn't decrypt
  # anything. As such, we don't need to override anything for it.

  alpha:
    # Overriding to add `--org` option
    command:
      - run
      - --listen-ctl=0.0.0.0:9632
      - --org=e2e
      - --peer=bastion.habitat.dev
    volumes:
      - source: ${TESTCASE_DIR}/cache_keys
        target: /hab/cache/keys
        type: bind

  beta:
    # Overriding to add `--org` option
    command:
      - run
      - --listen-ctl=0.0.0.0:9632
      - --org=e2e
      - --peer=bastion.habitat.dev
    volumes:
      - source: ${TESTCASE_DIR}/cache_keys
        target: /hab/cache/keys
        type: bind

  # This Supervisor will be like the others, except that it won't have
  # access to any user keys. As such, it shouldn't be able to decrypt
  # any encrypted messages.
  gamma:
    image: ${SUPERVISOR_IMAGE}
    domainname: habitat.dev
    environment:
      HAB_LICENSE: accept-no-persist
      HAB_NONINTERACTIVE: '1'
      TESTCASE: ${TESTCASE}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
      HAB_AUTH_TOKEN: ${HAB_AUTH_TOKEN}
    hostname: gamma
    networks:
      default:
        aliases:
        - gamma.habitat.dev
    command:
      - run
      - --listen-ctl=0.0.0.0:9632
      - --org=e2e
      - --peer=bastion.habitat.dev
    volumes:
      - source: ./CTL_SECRET
        target: /hab/sup/default/CTL_SECRET
        type: bind
      - source: ${TESTCASE_DIR}/cache_keys_no_user
        target: /hab/cache/keys
        type: bind
    depends_on:
      - bastion

  tester:
    image: ${TESTCASE}_image
    domainname: habitat.dev
    environment:
      HAB_LICENSE: accept-no-persist
      HAB_NONINTERACTIVE: '1'
      TESTCASE: ${TESTCASE}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
    build:
      context: ${TESTCASE_DIR}
    volumes:
      - source: ./CTL_SECRET
        target: /hab/sup/default/CTL_SECRET
        type: bind
      - source: /var/run/docker.sock
        target: /var/run/docker.sock
        type: bind
      - source: ../../../.expeditor/scripts
        target: /scripts
        type: bind
      # Strictly speaking, this container would only need access to
      # private user keys and public service keys (well, by the same
      # token, the others would strictly only need access to public
      # user keys and private service keys).
      - source: ${TESTCASE_DIR}/cache_keys
        target: /hab/cache/keys
        type: bind
    depends_on:
      - bastion
      - alpha
      - beta
      - gamma
