sudo: required
language: rust
addons:
  apt:
    packages:
    - build-essential
    - ca-certificates
    - curl
    - file
    - gdb
    - libarchive-dev
    - libprotobuf-dev
    - libssl-dev
    - libzmq-dev
    - pkg-config
    - protobuf-compiler
    - sudo
    - tmux
    - vim
    - wget
branches:
  only:
  - master
  - auto
cache:
  apt: true
  directories:
  - "$HOME/.cargo"
  - components/builder-api/target
  - components/builder-dbcache/target
  - components/builder-jobsrv/target
  - components/builder-protocol/target
  - components/builder-sessionsrv/target
  - components/builder-vault/target
  - components/builder-worker/target
  - components/common/target
  - components/core/target
  - components/depot-core/target
  - components/depot-client/target
  - components/depot/target
  - components/hab/target
  - components/net/target
  - components/sodiumoxide/target
  - components/sup/target
env:
  global:
  - PATH=$HOME/.cargo/bin:$PATH
  - secure: gdbeNjLU9smyegb7nNIwqi6oghu2TwQ9u0l0+BtqIUO6y3O/J9orkCGkWhwtaRkOtLVVakduC0qCCZDD24f/2aZoPN4XhHeNL6oDnq9TngKqi4/sOYRUQ5TB8xL+ja3H6Gx9bB1FhpohuMlfTbCnO3lLWP0Oj4btbcsfsYe8ytM=
  - secure: GoX6A9uqZ7avilS62w+Noju1ntmqK45C98apBrVnym0tDON3W7kJ5sUJiq6x3+oFOxn0QlaOX1Mku5GyesDE+NbGm4YlLLcucTv2gi9iab5HJsxhHNsLgyMWBPCj25n2qcaCQE0g7naRSThnpRFFV+U6wbqLBods0jKbL95yrPY=
services:
- docker
before_install:
- sudo add-apt-repository -y ppa:chris-lea/libsodium
- sudo add-apt-repository -y ppa:brightbox/ruby-ng
- sudo apt-get update
- sudo apt-get -y install docker iproute2 libsodium-dev man npm ruby2.3 ruby2.3-dev
- command -v protoc-gen-rust || cargo install protobuf
- sudo gem install bundler
script:
- "./support/ci.sh"
- "./support/website.sh"
notifications:
  slack:
    secure: FjTKlrpHSKlUktFSf9W6ANmxWujelaN4bPRletBXkNwmZYwpqN1YC4lFwS16X0J6kNyvHGRva018YsUMtwI/FXtHH3YliyxCivmEoeAlZa+jMdy16pmBGhxo+mPC92SnHt1DhXfQUTstWw3h+Lq2F2MfwrB8k+nVBFJjfrF8HY0=
  webhooks: http://willem.habitat.sh:54856/travis
deploy:
  provider: s3
  access_key_id: AKIAJD2LEPZPVODPFLIQ
  secret_access_key:
    secure: U1oAoekCDu6Qa94sANnJH9dfa6g0E9GpvDPwnE6Kv2/d8uprXapWtLvVJ8rnrB/4fLgDntqgMpZYbmETbsCkfnX1olxlch6J06Tel/xJPX//mPG7v3ZEYcpyKAfdI1X9je9jP23ijkEnFMtkjlJ/JDOd9nHqsbECeeUY3U8ZiUk=
  bucket: habitat-web-www
  local-dir: www/build
  skip_cleanup: true
  acl: public_read
  on:
    repo: habitat-sh/habitat
after_deploy:
- "./support/purge_website.sh"
