branches:
  only:
  - master
  - auto
env:
  global:
  - PATH=$HOME/.cargo/bin:$PATH
  - secure: gdbeNjLU9smyegb7nNIwqi6oghu2TwQ9u0l0+BtqIUO6y3O/J9orkCGkWhwtaRkOtLVVakduC0qCCZDD24f/2aZoPN4XhHeNL6oDnq9TngKqi4/sOYRUQ5TB8xL+ja3H6Gx9bB1FhpohuMlfTbCnO3lLWP0Oj4btbcsfsYe8ytM=
  - secure: GoX6A9uqZ7avilS62w+Noju1ntmqK45C98apBrVnym0tDON3W7kJ5sUJiq6x3+oFOxn0QlaOX1Mku5GyesDE+NbGm4YlLLcucTv2gi9iab5HJsxhHNsLgyMWBPCj25n2qcaCQE0g7naRSThnpRFFV+U6wbqLBods0jKbL95yrPY=
matrix:
  include:
  - language: node_js
    node_js: 4.2.6
    sudo: false
    compiler: clang-3.6
    env:
    - CXX=clang-3.6
    addons:
      apt:
        sources:
        - llvm-toolchain-precise-3.6
        - ubuntu-toolchain-r-test
        packages:
        - clang-3.6
        - g++-4.8
    cache:
      apt: true
      directories:
      - components/builder-web/node_modules
      - components/builder-web/typings
    before_install: npm config set spin=false
    install: "(cd components/builder-web && npm install)"
    script: "(cd components/builder-web && npm run travis)"
  - language: ruby
    rvm: 2.3.1
    sudo: false
    cache:
      bundle: true
      directories:
      - www/build
      - www/vendor/bundle
    install: "(cd www && bundle install --deployment)"
    script: "(cd www && bundle exec middleman build)"
    deploy:
      provider: s3
      access_key_id: AKIAJD2LEPZPVODPFLIQ
      secret_access_key:
        secure: U1oAoekCDu6Qa94sANnJH9dfa6g0E9GpvDPwnE6Kv2/d8uprXapWtLvVJ8rnrB/4fLgDntqgMpZYbmETbsCkfnX1olxlch6J06Tel/xJPX//mPG7v3ZEYcpyKAfdI1X9je9jP23ijkEnFMtkjlJ/JDOd9nHqsbECeeUY3U8ZiUk=
      bucket: habitat-web-www
      local-dir: www/build
      skip_cleanup: true
      acl: public_read
      on:
        repo: habitat-sh/habitat
    after_deploy:
    - "./support/purge_website.sh"
  - language: rust
    rust: nightly
    sudo: required
    addons:
      apt:
        packages:
        - build-essential
        - ca-certificates
        - curl
        - file
        - gdb
        - libarchive-dev
        - libprotobuf-dev
        - libssl-dev
        - pkg-config
        - protobuf-compiler
        - sudo
        - tmux
        - vim
        - wget
    cache:
      apt: true
      cargo: true
      directories:
      - "$HOME/rust"
      - components/builder-api/target
      - components/builder-dbcache/target
      - components/builder-jobsrv/target
      - components/builder-protocol/target
      - components/builder-sessionsrv/target
      - components/builder-vault/target
      - components/builder-worker/target
      - components/common/target
      - components/core/target
      - components/depot-core/target
      - components/depot-client/target
      - components/depot/target
      - components/hab/target
      - components/net/target
      - components/sodiumoxide/target
      - components/sup/target
    before_install:
    - sudo add-apt-repository -y ppa:chris-lea/libsodium
    - sudo apt-get update
    - sudo apt-get -y install docker iproute2 libsodium-dev libzmq-dev
    - command -v protoc-gen-rust || cargo install protobuf
    - openssl aes-256-cbc -K $encrypted_c4f852370b68_key -iv $encrypted_c4f852370b68_iv -in core-20160423193745.sig.key.enc -out core-20160423193745.sig.key -d
    script:
    - ./support/ci.sh
    - sudo -E bash -c "./support/publish.sh"
    services: docker
notifications:
  slack:
    secure: FjTKlrpHSKlUktFSf9W6ANmxWujelaN4bPRletBXkNwmZYwpqN1YC4lFwS16X0J6kNyvHGRva018YsUMtwI/FXtHH3YliyxCivmEoeAlZa+jMdy16pmBGhxo+mPC92SnHt1DhXfQUTstWw3h+Lq2F2MfwrB8k+nVBFJjfrF8HY0=
  webhooks: http://willem.habitat.sh:54856/travis
